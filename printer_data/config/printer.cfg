#[include Jomik.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
[include mmu/addons/mmu_erec_cutter.cfg]
[include mmu/addons/purge_clean.cfg]
# Enable object exclusion
[exclude_object]

# Enable arcs support
#resolution: 0.1

[include K-ShakeTune/*.cfg]
[include cartographer.cfg]
[include Ebb42.cfg]
#[include PIS.cfg]
[include Sensorless.cfg]
[include mainsail.cfg]
[include Macros.cfg]
[include Neopixel.cfg]

[mcu]
canbus_uuid: 3149463764eb
[mcu mmu]
serial: /dev/serial/by-id/usb-Klipper_samd21g18a_F1BB1CDB5130545120202046171116FF-if00

[gcode_macro START_PRINT]
gcode: 
    STATUS_READY
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(149)|float %}
    M140 S{BED_TEMP}
    M104 S149  

    M117 print start
  
    G90  
    G28 
    Z_TILT_ADJUST
    
    STATUS_MESHING
    M117 Cartographer scanning bed...
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE=default
    BED_MESH_PROFILE LOAD=default
    STATUS_CALIBRATING_Z
    BRUSH_NOZZLE
    TOUCH_HOME
    G1 X257 Y78 F9000
    STATUS_HEATING
    M117 heating...    
    M109 S{EXTRUDER_TEMP} 
    
       
#[scanner]
##serial:/dev/serial/by-id/usb-Cartographer_stm32g431xx_210042001350303352323620-if00
#canbus_uuid: ebf3772b6bf5
##
#backlash_comp: 0.00489
##   Backlash compensation distance for removing Z backlash before measuring
##   the sensor response.
#x_offset: 0
##   X offset of cartographer from the nozzle.
#y_offset: 27
##   Y offset of cartographer from the nozzle.
#mesh_main_direction: x
##   Primary travel direction during mesh measurement.
#mesh_runs: 2
#mode: touch 
#sensor: cartographer
#sensor_alt: c ## allows use of shorter commands. ie CARTO_TOUCH instead of CARTOGRAPHER_TOUCH
#scanner_touch_z_offset: 0.05


[input_shaper]
shaper_freq_x: 70
shaper_type_x: mzv
shaper_freq_y: 49
shaper_type_y: mzv

[idle_timeout]
timeout: 14400
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[force_move]
enable_force_move: True

#Driver_0
[stepper_x]
step_pin: !PF13
dir_pin: !PF12
enable_pin: !PF14
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop #!PG6
position_endstop: 258
position_max: 258
position_min: -25
homing_speed: 60
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: ^PG6
run_current: 1.38
stealthchop_threshold: 0
driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

#Driver_3
[stepper_x1]
step_pin: !PG4
dir_pin: !PC1
enable_pin: !PA0
microsteps: 128
rotation_distance: 40

[tmc2209 stepper_x1]
uart_pin: PC7
#diag_pin: ^PG11
run_current: 1.38
stealthchop_threshold: 0
#driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

#Driver_1
[stepper_y]
step_pin: !PG0
dir_pin: !PG1
enable_pin: !PF15
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop #!PG9
position_endstop: 237
position_max: 237
position_min: -25
homing_speed: 60
homing_positive_dir: true
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
run_current: 1.38
stealthchop_threshold: 0
driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

#Driver_4
[stepper_y1]
step_pin: !PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 128
rotation_distance: 40

[tmc2209 stepper_y1]
uart_pin: PF2
#diag_pin: PG12
run_current: 1.38
stealthchop_threshold: 0
#driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

[stepper_z]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
microsteps: 128
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -5
homing_speed: 5
second_homing_speed: 1
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PE4
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z1]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z1]
uart_pin: PE1
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z2]
step_pin: PE6
dir_pin: !PA14
enable_pin: !PE0
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z2]
uart_pin: PD3
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[heater_bed]
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
#control: pid
# tuned for stock hardware with 70 degree Celsius target
#pid_kp: 70.405
#pid_ki: 1.229
#pid_kd: 1008.553
min_temp: 0
max_temp: 200

[controller_fan Step]
pin: PA8
fan_speed: 1.0
stepper: stepper_x, stepper_y

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 21200
max_z_velocity: 5
square_corner_velocity: 5.0
max_z_accel: 100

[bed_mesh]
speed: 300
mesh_min: 20,20        # Need to handle head distance with cr-touch (bl_touch)
mesh_max: 215,215      # Max probe range
probe_count: 23,23
fade_start: 2
fade_end: 10
fade_target: 0
mesh_pps: 0,0
algorithm: bicubic
bicubic_tension: 0.2
zero_reference_position: 117, 118
horizontal_move_z: 3

[bed_screws]
screw1:25,40
screw1_name:1
screw2:195,40
screw2_name:2
screw3:25,210
screw3_name:3
screw4:195,210
screw4_name:4

[screws_tilt_adjust]
screw1: 67, 42
screw1_name: front left screw
screw2: 237.60, 42
screw2_name: front right screw
screw3: 237.60, 212
screw3_name: rear right screw
screw4: 67.60, 212
screw4_name: rear left screw
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4 # Use CW for Clockwise and CCW for Counter Clockwise

[z_tilt]
z_positions:
  -31,125   #Z0
  260,125  #Z1
  118,272  #z2
points:
  15,-4
  220,-4
  118,184
horizontal_move_z: 5
retries: 10
retry_tolerance: 0.0075
speed: 400

[axis_twist_compensation]
calibrate_y: 117
calibrate_start_x: 20
calibrate_end_x: 215
calibrate_x: 117
calibrate_start_y: 11
calibrate_end_y: 184

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 #usbadxl
accel_chip: adxl345 
probe_points: 117,118,20 # an example
ACCEL_PER_HZ: 200

#[adxl345]
#cs_pin: cartographer:PA3
#spi_bus: spi1
#axes_map: x,y,z

#[resonance_tester]
#accel_chip: adxl345
#probe_points: 117, 118, 20

[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan

[temperature_sensor mcu]
sensor_type: temperature_mcu
sensor_mcu: mcu
[temperature_sensor host]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp

#[temperature_sensor Cartographer_mcu]
#sensor_type: temperature_mcu
#sensor_mcu: scanner


[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_data: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


########################################
# TMC2209 configuration
########################################

#[tmc2209 stepper_z]
#uart_pin: PC6
#diag_pin: PG10
#run_current: 0.567
#stealthchop_threshold: 999999

#[tmc2209 extruder]
#uart_pin: PD3
#run_current: 0.650
#hold_current: 0.1
#stealthchop_threshold: 0
#interpolate: False

#[heater_fan hotend_fan]
#pin: PE5
#max_power: 1.0
#kick_start_time: 0.5
#heater: extruder
#heater_temp: 50.0

#[heater_fan fan2]
#pin: PD12

#[heater_fan fan3]
#pin: PD13

#[heater_fan fan4]
#pin: PD14
#[controller_fan fan5]
#pin: PD15

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.443
#*# pid_ki = 1.409
#*# pid_kd = 433.861
#*#
#*# [input_shaper]
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.055560, -0.055356, -0.053219, -0.040436, -0.030348, -0.016920, -0.010063, 0.006608, 0.009889, 0.018157, 0.017407, 0.021105, 0.001028, -0.028862, -0.046104, -0.063759, -0.072364, -0.079015, -0.077686, -0.069600, -0.066116, -0.057653, -0.017364
#*# 	  -0.049180, -0.057928, -0.048728, -0.038742, -0.030117, -0.022659, -0.012755, -0.000749, 0.002175, 0.009274, 0.007566, 0.009438, -0.015049, -0.040839, -0.056464, -0.065009, -0.081444, -0.086315, -0.084093, -0.085593, -0.088347, -0.060835, -0.068980
#*# 	  -0.070105, -0.049581, -0.051432, -0.034829, -0.023180, -0.020385, -0.019468, -0.003952, -0.002061, 0.001281, 0.006453, 0.006764, -0.013442, -0.033798, -0.054141, -0.068166, -0.072616, -0.077727, -0.079881, -0.078268, -0.081775, -0.074038, -0.049715
#*# 	  -0.032560, -0.048347, -0.038478, -0.031485, -0.025147, -0.018368, -0.015450, -0.008409, -0.006820, -0.000501, -0.000010, 0.005059, -0.008929, -0.030335, -0.046672, -0.058855, -0.077336, -0.083142, -0.078452, -0.088343, -0.088021, -0.074159, -0.080957
#*# 	  -0.054007, -0.034973, -0.035706, -0.025608, -0.016373, -0.017130, -0.020070, -0.008375, -0.009065, -0.005892, -0.002568, -0.000148, -0.015791, -0.030836, -0.050619, -0.066178, -0.078528, -0.089193, -0.094899, -0.087284, -0.090732, -0.089159, -0.069892
#*# 	  -0.026372, -0.033087, -0.026079, -0.018196, -0.019250, -0.017934, -0.019744, -0.014481, -0.014532, -0.009302, -0.010881, -0.007546, -0.015711, -0.037406, -0.054690, -0.068846, -0.089610, -0.094371, -0.093689, -0.102030, -0.099715, -0.088255, -0.105818
#*# 	  -0.040406, -0.020369, -0.025192, -0.015917, -0.013501, -0.014816, -0.017101, -0.006637, -0.009570, -0.013126, -0.009261, -0.007436, -0.021560, -0.036816, -0.055678, -0.072870, -0.089396, -0.097283, -0.103646, -0.099477, -0.099923, -0.102247, -0.089547
#*# 	  -0.013823, -0.024030, -0.021552, -0.016864, -0.017724, -0.018997, -0.019920, -0.016275, -0.015374, -0.013892, -0.015233, -0.013389, -0.024722, -0.045610, -0.060294, -0.077480, -0.099460, -0.104824, -0.106477, -0.111650, -0.112860, -0.108087, -0.118034
#*# 	  -0.042705, -0.021123, -0.026778, -0.020341, -0.014350, -0.018796, -0.021259, -0.014461, -0.015183, -0.017611, -0.014420, -0.014533, -0.029044, -0.045568, -0.063085, -0.080611, -0.099645, -0.111516, -0.115298, -0.108299, -0.104691, -0.103319, -0.092299
#*# 	  -0.010186, -0.016738, -0.015963, -0.010182, -0.008521, -0.012174, -0.015750, -0.009228, -0.013866, -0.009318, -0.010369, -0.005905, -0.022438, -0.042078, -0.061422, -0.080312, -0.106043, -0.118309, -0.113392, -0.114964, -0.107142, -0.099186, -0.121356
#*# 	  -0.032987, -0.013257, -0.013289, -0.003571, -0.004215, -0.012302, -0.015136, -0.008967, -0.009115, -0.011607, -0.007453, -0.006017, -0.021621, -0.042420, -0.063451, -0.087893, -0.109353, -0.122754, -0.121020, -0.108882, -0.095835, -0.100964, -0.098811
#*# 	  -0.009382, -0.010977, -0.004458, -0.001143, 0.000379, -0.004770, -0.006848, -0.001247, -0.002533, -0.003225, -0.003495, -0.000154, -0.015660, -0.040167, -0.063459, -0.085421, -0.107532, -0.114376, -0.112918, -0.112784, -0.107950, -0.107318, -0.130184
#*# 	  -0.027819, -0.007304, -0.007178, 0.003476, 0.004633, 0.000261, -0.001251, 0.006520, 0.004129, 0.001138, 0.003866, 0.005108, -0.013939, -0.034521, -0.055338, -0.081879, -0.101969, -0.106844, -0.111123, -0.109652, -0.110826, -0.110457, -0.106360
#*# 	  -0.021152, -0.022652, -0.019952, -0.013169, -0.008738, -0.011229, -0.009062, -0.007515, -0.006419, -0.008835, -0.006955, -0.007149, -0.024869, -0.046347, -0.065950, -0.089626, -0.112831, -0.115239, -0.114377, -0.124040, -0.127351, -0.121281, -0.137718
#*# 	  -0.062591, -0.046432, -0.045108, -0.034189, -0.030051, -0.030875, -0.030657, -0.022468, -0.022241, -0.022720, -0.022462, -0.022469, -0.039035, -0.061859, -0.080647, -0.101633, -0.118793, -0.125438, -0.131791, -0.138840, -0.133365, -0.129849, -0.123348
#*# 	  -0.073764, -0.072897, -0.066560, -0.060906, -0.050620, -0.052441, -0.049076, -0.041213, -0.040247, -0.039670, -0.037902, -0.037924, -0.053806, -0.075024, -0.094987, -0.113601, -0.134479, -0.143556, -0.147241, -0.150829, -0.150096, -0.142360, -0.156954
#*# 	  -0.119923, -0.100961, -0.098754, -0.086147, -0.076366, -0.069845, -0.066703, -0.059433, -0.058665, -0.055476, -0.053127, -0.050992, -0.068421, -0.087980, -0.105253, -0.125441, -0.146774, -0.158895, -0.159048, -0.165845, -0.170122, -0.172782, -0.160550
#*# 	  -0.135704, -0.133189, -0.127382, -0.116153, -0.103977, -0.097658, -0.087663, -0.078568, -0.076173, -0.074502, -0.069454, -0.068373, -0.086351, -0.104684, -0.121633, -0.139065, -0.162088, -0.170180, -0.172085, -0.180266, -0.188642, -0.188736, -0.193066
#*# 	  -0.161750, -0.145591, -0.141059, -0.125044, -0.112463, -0.107032, -0.094825, -0.085604, -0.079111, -0.073184, -0.069055, -0.068509, -0.085142, -0.102741, -0.119581, -0.138203, -0.157349, -0.167786, -0.171293, -0.180212, -0.185628, -0.186894, -0.181642
#*# 	  -0.150279, -0.157293, -0.144258, -0.128776, -0.111199, -0.103639, -0.093597, -0.080799, -0.069113, -0.061940, -0.057191, -0.059579, -0.073907, -0.092269, -0.110548, -0.132931, -0.153298, -0.164367, -0.172687, -0.181338, -0.184820, -0.181039, -0.188480
#*# 	  -0.171889, -0.153363, -0.139507, -0.120560, -0.114000, -0.104151, -0.092730, -0.079357, -0.073684, -0.063769, -0.058533, -0.060608, -0.074086, -0.096459, -0.110724, -0.130892, -0.156530, -0.166836, -0.172360, -0.187598, -0.187565, -0.184870, -0.176573
#*# 	  -0.166558, -0.163553, -0.152492, -0.133862, -0.124594, -0.112199, -0.100957, -0.087223, -0.079816, -0.071204, -0.063145, -0.061008, -0.077551, -0.097199, -0.114089, -0.135342, -0.154840, -0.167505, -0.173712, -0.179076, -0.184683, -0.182128, -0.186727
#*# 	  -0.185873, -0.170265, -0.161406, -0.142148, -0.129696, -0.119195, -0.106540, -0.090223, -0.084501, -0.075458, -0.067183, -0.061657, -0.075443, -0.096397, -0.116736, -0.135194, -0.155478, -0.165923, -0.162358, -0.169362, -0.174531, -0.175099, -0.182025
#*# x_count = 23
#*# y_count = 23
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 214.92
#*# min_y = 20.0
#*# max_y = 214.92000000000013
#*#
#*# [cartographer scan_model default]
#*# z_offset = 0
#*# coefficients = 1.4986141535904032, 1.941444988144312, 0.8502011559917134, 0.33952044904949397, 0.25176039278093176, 0.6832247985892915, 0.10642367134097327, -0.7519135386893779, 0.09343333447252065, 0.4891501052840694
#*# domain = 3.209386724348187e-07, 3.3357096766991926e-07
#*#
#*# [cartographer touch_model default]
#*# threshold = 600
#*# speed = 1.0
#*# z_offset = -0.050
#*#
#*# [axis_twist_compensation]
#*# zy_compensations = -0.019303, -0.017714, 0.018143, -0.015163, 0.034037
#*# compensation_start_y = 11.0
#*# compensation_end_y = 184.0
#*# z_compensations = 0.032230, 0.008793, 0.028668, -0.027585, -0.042107
#*# compensation_start_x = 20.0
#*# compensation_end_x = 215.0
