#[include Jomik.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
[include mmu/addons/mmu_erec_cutter.cfg]
[include mmu/addons/purge_clean.cfg]
# Enable object exclusion
[exclude_object]

# Enable arcs support
#resolution: 0.1

[include K-ShakeTune/*.cfg]
[include cartographer.cfg]
[include Ebb42.cfg]
#[include PIS.cfg]
[include Sensorless.cfg]
[include mainsail.cfg]
[include Macros.cfg]
[include Neopixel.cfg]

[mcu]
canbus_uuid: 3149463764eb
[mcu mmu]
serial: /dev/serial/by-id/usb-Klipper_samd21g18a_F1BB1CDB5130545120202046171116FF-if00

[gcode_macro START_PRINT]
gcode: 
    STATUS_READY
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(149)|float %}
    M140 S{BED_TEMP}
    M104 S149  

    M117 print start
  
    G90  
    G28 
    Z_TILT_ADJUST
    
    STATUS_MESHING
    M117 Cartographer scanning bed...
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE=default
    BED_MESH_PROFILE LOAD=default
    STATUS_CALIBRATING_Z
    BRUSH_NOZZLE
    TOUCH_HOME
    G1 X257 Y78 F9000
    STATUS_HEATING
    M117 heating...    
    M109 S{EXTRUDER_TEMP} 
    
       
#[scanner]
##serial:/dev/serial/by-id/usb-Cartographer_stm32g431xx_210042001350303352323620-if00
#canbus_uuid: ebf3772b6bf5
##
#backlash_comp: 0.00489
##   Backlash compensation distance for removing Z backlash before measuring
##   the sensor response.
#x_offset: 0
##   X offset of cartographer from the nozzle.
#y_offset: 27
##   Y offset of cartographer from the nozzle.
#mesh_main_direction: x
##   Primary travel direction during mesh measurement.
#mesh_runs: 2
#mode: touch 
#sensor: cartographer
#sensor_alt: c ## allows use of shorter commands. ie CARTO_TOUCH instead of CARTOGRAPHER_TOUCH
#scanner_touch_z_offset: 0.05


[input_shaper]
shaper_freq_x: 68.6
shaper_type_x: mzv
shaper_freq_y: 45.6
shaper_type_y: mzv

[idle_timeout]
timeout: 14400
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[force_move]
enable_force_move: True

#Driver_0
[stepper_x]
step_pin: !PF13
dir_pin: !PF12
enable_pin: !PF14
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop #!PG6
position_endstop: 258
position_max: 258
position_min: -25
homing_speed: 60
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: ^PG6
run_current: 1.38
stealthchop_threshold: 0
driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110

#Driver_3
[stepper_x1]
step_pin: !PG4
dir_pin: !PC1
enable_pin: !PA0
microsteps: 128
rotation_distance: 40

[tmc2209 stepper_x1]
uart_pin: PC7
#diag_pin: ^PG11
run_current: 1.38
stealthchop_threshold: 0
#driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110

#Driver_1
[stepper_y]
step_pin: !PG0
dir_pin: !PG1
enable_pin: !PF15
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop #!PG9
position_endstop: 237
position_max: 237
position_min: -25
homing_speed: 60
homing_positive_dir: true
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
run_current: 1.38
stealthchop_threshold: 0
driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110

#Driver_4
[stepper_y1]
step_pin: !PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 128
rotation_distance: 40

[tmc2209 stepper_y1]
uart_pin: PF2
#diag_pin: PG12
run_current: 1.38
stealthchop_threshold: 0
#driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110

[stepper_z]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
microsteps: 128
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -5
homing_speed: 5
second_homing_speed: 1
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PE4
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z1]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z1]
uart_pin: PE1
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z2]
step_pin: PE6
dir_pin: !PA14
enable_pin: !PE0
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z2]
uart_pin: PD3
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[heater_bed]
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
#control: pid
# tuned for stock hardware with 70 degree Celsius target
#pid_kp: 70.405
#pid_ki: 1.229
#pid_kd: 1008.553
min_temp: 0
max_temp: 200

[controller_fan Step]
pin: PA8
fan_speed: 1.0
stepper: stepper_x, stepper_y

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 21200
max_z_velocity: 5
square_corner_velocity: 5.0
max_z_accel: 100

[bed_mesh]
speed: 300
mesh_min: 15,10        # Need to handle head distance with cr-touch (bl_touch)
mesh_max: 220,225      # Max probe range
probe_count: 9,9
fade_start: 1
fade_end: 10
fade_target: 0
#mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2
zero_reference_position: 117, 118

[bed_screws]
screw1:25,40
screw1_name:1
screw2:195,40
screw2_name:2
screw3:25,210
screw3_name:3
screw4:195,210
screw4_name:4

[screws_tilt_adjust]
screw1: 67, 42
screw1_name: front left screw
screw2: 237.60, 42
screw2_name: front right screw
screw3: 237.60, 212
screw3_name: rear right screw
screw4: 67.60, 212
screw4_name: rear left screw
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4 # Use CW for Clockwise and CCW for Counter Clockwise

[z_tilt]
z_positions:
  -31,125   #Z0
  260,125  #Z1
  118,272  #z2
points:
  15,-4
  220,-4
  118,190
horizontal_move_z: 5
retries: 10
retry_tolerance: 0.0075
speed: 400

[axis_twist_compensation]
calibrate_y: 117
calibrate_start_x: 20
calibrate_end_x: 215
calibrate_x: 117
calibrate_start_y: 11
calibrate_end_y: 198

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 #usbadxl
accel_chip: adxl345 
probe_points: 117,118,20 # an example

#[adxl345]
#cs_pin: scanner:PA3
#spi_bus: spi1

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
    #117, 118, 20

[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan

[temperature_sensor mcu]
sensor_type: temperature_mcu
sensor_mcu: mcu
[temperature_sensor host]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp

#[temperature_sensor Cartographer_mcu]
#sensor_type: temperature_mcu
#sensor_mcu: scanner


[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_data: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


########################################
# TMC2209 configuration
########################################

#[tmc2209 stepper_z]
#uart_pin: PC6
#diag_pin: PG10
#run_current: 0.567
#stealthchop_threshold: 999999

#[tmc2209 extruder]
#uart_pin: PD3
#run_current: 0.650
#hold_current: 0.1
#stealthchop_threshold: 0
#interpolate: False

#[heater_fan hotend_fan]
#pin: PE5
#max_power: 1.0
#kick_start_time: 0.5
#heater: extruder
#heater_temp: 50.0

#[heater_fan fan2]
#pin: PD12

#[heater_fan fan3]
#pin: PD13

#[heater_fan fan4]
#pin: PD14
#[controller_fan fan5]
#pin: PD15

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.443
#*# pid_ki = 1.409
#*# pid_kd = 433.861
#*#
#*# [input_shaper]
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.081780, -0.066123, -0.069478, -0.062717, -0.037689, -0.012279, -0.002367, -0.003788, -0.006249, -0.017829, -0.022691, -0.030115, -0.040052, -0.044222, -0.050881, -0.061293, -0.061178, -0.064643, -0.082111, -0.077731, -0.059044, -0.055908, -0.021480
#*# 	-0.031299, -0.025923, -0.019706, -0.015724, -0.011003, 0.003275, 0.009306, 0.002605, 0.000903, -0.006748, -0.021310, -0.025117, -0.032693, -0.041982, -0.050906, -0.057543, -0.065318, -0.060338, -0.056779, -0.053952, -0.038361, -0.020412, -0.029800
#*# 	-0.037748, -0.010383, -0.010508, -0.004792, 0.007725, 0.013350, 0.016324, 0.011088, 0.005104, -0.007251, -0.012541, -0.023585, -0.032936, -0.041064, -0.050601, -0.062452, -0.061665, -0.058543, -0.060418, -0.049168, -0.036931, -0.032981, -0.034210
#*# 	-0.008224, 0.002184, 0.009157, 0.012998, 0.017556, 0.026378, 0.028352, 0.018439, 0.011009, 0.004672, -0.007619, -0.016143, -0.025882, -0.039638, -0.048401, -0.058368, -0.065042, -0.062258, -0.059158, -0.056333, -0.047389, -0.035736, -0.059468
#*# 	-0.011170, 0.019586, 0.022605, 0.027745, 0.035921, 0.039100, 0.036158, 0.026769, 0.017085, 0.007785, -0.000413, -0.010789, -0.025728, -0.035783, -0.044942, -0.058900, -0.060389, -0.057912, -0.060237, -0.053662, -0.037841, -0.043937, -0.052799
#*# 	0.021307, 0.035625, 0.038542, 0.043879, 0.047402, 0.050817, 0.048138, 0.032744, 0.022430, 0.015974, 0.002362, -0.004929, -0.016696, -0.032414, -0.042224, -0.053884, -0.062879, -0.059595, -0.056327, -0.054581, -0.045314, -0.039169, -0.066849
#*# 	0.007307, 0.048698, 0.050600, 0.053282, 0.058799, 0.056877, 0.052279, 0.038346, 0.026062, 0.013420, 0.004970, -0.004617, -0.016623, -0.030282, -0.044261, -0.054722, -0.060552, -0.060984, -0.057740, -0.052470, -0.047464, -0.044283, -0.060910
#*# 	0.038835, 0.055951, 0.058724, 0.062418, 0.062300, 0.062560, 0.055553, 0.041512, 0.027688, 0.016467, 0.002596, -0.006268, -0.018736, -0.032700, -0.045290, -0.054803, -0.066107, -0.064162, -0.058960, -0.056474, -0.048956, -0.043412, -0.093854
#*# 	0.022922, 0.063194, 0.064591, 0.068693, 0.072605, 0.068583, 0.062201, 0.045837, 0.032703, 0.015519, 0.006292, -0.005791, -0.018946, -0.031563, -0.043200, -0.055473, -0.063918, -0.064116, -0.061259, -0.055733, -0.048808, -0.047165, -0.067424
#*# 	0.051167, 0.068312, 0.070097, 0.074235, 0.075062, 0.071636, 0.063561, 0.047515, 0.032841, 0.018095, 0.003420, -0.005948, -0.019664, -0.034024, -0.044900, -0.056946, -0.066073, -0.065609, -0.060339, -0.060271, -0.053785, -0.049735, -0.096408
#*# 	0.031647, 0.074850, 0.074967, 0.078485, 0.080555, 0.074541, 0.065173, 0.050038, 0.035257, 0.018385, 0.006449, -0.006078, -0.018414, -0.031090, -0.044254, -0.057323, -0.064868, -0.063335, -0.062001, -0.059165, -0.053441, -0.050450, -0.069366
#*# 	0.059224, 0.079240, 0.082036, 0.085982, 0.086354, 0.080338, 0.070389, 0.053808, 0.036918, 0.021753, 0.006643, -0.003705, -0.015013, -0.029782, -0.040515, -0.052275, -0.061162, -0.059490, -0.057292, -0.057356, -0.052359, -0.046647, -0.094046
#*# 	0.043642, 0.084721, 0.086701, 0.091492, 0.091557, 0.084811, 0.074856, 0.058136, 0.040234, 0.025275, 0.014307, 0.001313, -0.011362, -0.024867, -0.035881, -0.048070, -0.056398, -0.054725, -0.052960, -0.050631, -0.046736, -0.044731, -0.062471
#*# 	0.061919, 0.081881, 0.084665, 0.088715, 0.089665, 0.085758, 0.073898, 0.058749, 0.040380, 0.022508, 0.012165, 0.000857, -0.012593, -0.026152, -0.037393, -0.047876, -0.056368, -0.054896, -0.051204, -0.051089, -0.047757, -0.045934, -0.090788
#*# 	0.038425, 0.077745, 0.080001, 0.083508, 0.086122, 0.083256, 0.074200, 0.058665, 0.040734, 0.024880, 0.012162, -0.000185, -0.011792, -0.025982, -0.034920, -0.046758, -0.054291, -0.052208, -0.049019, -0.049314, -0.046532, -0.045952, -0.068322
#*# 	0.042396, 0.062341, 0.062732, 0.068479, 0.072357, 0.071277, 0.062952, 0.048187, 0.031499, 0.015897, 0.004105, -0.007759, -0.020274, -0.032736, -0.043556, -0.055002, -0.061970, -0.060453, -0.057558, -0.057153, -0.054194, -0.052012, -0.097070
#*# 	0.008847, 0.044543, 0.046519, 0.051365, 0.055884, 0.057343, 0.052501, 0.040540, 0.024357, 0.007882, -0.001185, -0.012531, -0.025738, -0.040096, -0.048728, -0.059185, -0.067160, -0.065779, -0.062033, -0.063843, -0.061907, -0.059115, -0.079675
#*# 	0.001107, 0.023515, 0.024361, 0.030569, 0.038118, 0.041561, 0.038499, 0.027553, 0.012273, 0.000048, -0.010397, -0.020548, -0.034660, -0.048588, -0.057806, -0.068604, -0.076678, -0.075547, -0.073023, -0.071824, -0.071993, -0.067677, -0.108056
#*# 	-0.030542, 0.005703, 0.007954, 0.014824, 0.022796, 0.029043, 0.028404, 0.016789, 0.004461, -0.005857, -0.015405, -0.028770, -0.039378, -0.052763, -0.063909, -0.072757, -0.082166, -0.080928, -0.078791, -0.079550, -0.075803, -0.072121, -0.088248
#*# 	-0.029966, -0.009539, -0.009353, -0.001600, 0.008927, 0.014839, 0.015577, 0.007791, -0.002655, -0.012742, -0.022127, -0.033524, -0.046457, -0.057977, -0.068694, -0.080107, -0.089740, -0.089319, -0.087166, -0.086209, -0.081418, -0.072837, -0.105476
#*# 	-0.050432, -0.016671, -0.013708, -0.005933, 0.003847, 0.010548, 0.011995, 0.004585, -0.004817, -0.013534, -0.022068, -0.032274, -0.042630, -0.056518, -0.067543, -0.077187, -0.087131, -0.086361, -0.085403, -0.082796, -0.077673, -0.070556, -0.081764
#*# 	-0.039014, -0.021895, -0.023510, -0.015842, -0.005178, 0.001521, 0.003958, -0.000419, -0.011140, -0.019180, -0.026506, -0.036854, -0.047740, -0.060943, -0.071011, -0.079518, -0.088553, -0.087512, -0.085071, -0.080551, -0.074020, -0.067177, -0.092172
#*# 	-0.087756, -0.072094, -0.071592, -0.065663, -0.057020, -0.048540, -0.044727, -0.050868, -0.058723, -0.066738, -0.074706, -0.082085, -0.093197, -0.105461, -0.115135, -0.123973, -0.130178, -0.125619, -0.121676, -0.116115, -0.108211, -0.098295, -0.113925
#*# x_count = 23
#*# y_count = 23
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 219.82000000000002
#*# min_y = 10.0
#*# max_y = 214.82000000000005
#*#
#*# [cartographer scan_model default]
#*# z_offset = 0
#*# coefficients = 1.4986141535904032, 1.941444988144312, 0.8502011559917134, 0.33952044904949397, 0.25176039278093176, 0.6832247985892915, 0.10642367134097327, -0.7519135386893779, 0.09343333447252065, 0.4891501052840694
#*# domain = 3.209386724348187e-07, 3.3357096766991926e-07
#*#
#*# [cartographer touch_model default]
#*# threshold = 1000
#*# speed = 3.0
#*# z_offset = -0.05
