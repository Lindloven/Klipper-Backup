#[include Jomik.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
[include mmu/addons/mmu_erec_cutter.cfg]
[include mmu/addons/purge_clean.cfg]
# Enable object exclusion
[exclude_object]

# Enable arcs support
#resolution: 0.1

[include K-ShakeTune/*.cfg]
[include cartographer.cfg]
[include Ebb42.cfg]
#[include PIS.cfg]
[include Sensorless.cfg]
[include mainsail.cfg]
[include Macros.cfg]
[include Neopixel.cfg]

[mcu]
canbus_uuid: 3149463764eb
[mcu mmu]
serial: /dev/serial/by-id/usb-Klipper_samd21g18a_F1BB1CDB5130545120202046171116FF-if00

[gcode_macro START_PRINT]
gcode: 
    STATUS_READY
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(149)|float %}
    M140 S{BED_TEMP}
    M104 S149  

    M117 print start
  
    G90  
    G28 
    Z_TILT_ADJUST
    
    STATUS_MESHING
    M117 Cartographer scanning bed...
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE=default
    BED_MESH_PROFILE LOAD=default
    STATUS_CALIBRATING_Z
    BRUSH_NOZZLE
    TOUCH_HOME
    G1 X257 Y78 F9000
    STATUS_HEATING
    M117 heating...    
    M109 S{EXTRUDER_TEMP}
    G1 X3 Y3 Z0 F9000  ; move to corner    
    G1 Z0.2 F300 ; raise nozzle to 0.2  
    G92 E0.0 ; reset extruder distance position
    G1 X60.0 E9.0 F1000.0 ; intro line 
    G1 X10
    G0 Z2   
    G92 E0.0 ; reset extruder distance position
    
       
#[scanner]
##serial:/dev/serial/by-id/usb-Cartographer_stm32g431xx_210042001350303352323620-if00
#canbus_uuid: ebf3772b6bf5
##
#backlash_comp: 0.00489
##   Backlash compensation distance for removing Z backlash before measuring
##   the sensor response.
#x_offset: 0
##   X offset of cartographer from the nozzle.
#y_offset: 27
##   Y offset of cartographer from the nozzle.
#mesh_main_direction: x
##   Primary travel direction during mesh measurement.
#mesh_runs: 2
#mode: touch 
#sensor: cartographer
#sensor_alt: c ## allows use of shorter commands. ie CARTO_TOUCH instead of CARTOGRAPHER_TOUCH
#scanner_touch_z_offset: 0.05


[input_shaper]
shaper_freq_x: 57.2
shaper_type_x: mzv
shaper_freq_y: 53
shaper_type_y: mzv

[idle_timeout]
timeout: 14400
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[force_move]
enable_force_move: True

#Driver_0
[stepper_x]
step_pin: !PF13
dir_pin: !PF12
enable_pin: !PF14
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop #!PG6
position_endstop: 258
position_max: 258
position_min: -25
homing_speed: 60
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: ^PG6
run_current: 1.38
stealthchop_threshold: 0
driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

#Driver_3
[stepper_x1]
step_pin: !PG4
dir_pin: !PC1
enable_pin: !PA0
microsteps: 128
rotation_distance: 40

[tmc2209 stepper_x1]
uart_pin: PC7
#diag_pin: ^PG11
run_current: 1.38
stealthchop_threshold: 0
#driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

#Driver_1
[stepper_y]
step_pin: !PG0
dir_pin: !PG1
enable_pin: !PF15
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop #!PG9
position_endstop: 237
position_max: 237
position_min: -25
homing_speed: 60
homing_positive_dir: true
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
run_current: 1.38
stealthchop_threshold: 0
driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

#Driver_4
[stepper_y1]
step_pin: !PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 128
rotation_distance: 40

[tmc2209 stepper_y1]
uart_pin: PF2
#diag_pin: PG12
run_current: 1.38
stealthchop_threshold: 0
#driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 2

[stepper_z]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
microsteps: 128
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -5
homing_speed: 5
second_homing_speed: 1
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PE4
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z1]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z1]
uart_pin: PE1
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z2]
step_pin: PE6
dir_pin: !PA14
enable_pin: !PE0
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z2]
uart_pin: PD3
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[heater_bed]
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
#control: pid
# tuned for stock hardware with 70 degree Celsius target
#pid_kp: 70.405
#pid_ki: 1.229
#pid_kd: 1008.553
min_temp: 0
max_temp: 200

[controller_fan Step]
pin: PA8
fan_speed: 1.0
stepper: stepper_x, stepper_y

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 21200
max_z_velocity: 5
square_corner_velocity: 5.0
max_z_accel: 100

[bed_mesh]
speed: 300
mesh_min: 20,20        # Need to handle head distance with cr-touch (bl_touch)
mesh_max: 215,215      # Max probe range
probe_count: 23,23
fade_start: 2
fade_end: 10
fade_target: 0
mesh_pps: 0,0
algorithm: bicubic
bicubic_tension: 0.2
zero_reference_position: 117, 118
horizontal_move_z: 3

[bed_screws]
screw1:25,40
screw1_name:1
screw2:195,40
screw2_name:2
screw3:25,210
screw3_name:3
screw4:195,210
screw4_name:4

[screws_tilt_adjust]
screw1: 67, 42
screw1_name: front left screw
screw2: 237.60, 42
screw2_name: front right screw
screw3: 237.60, 212
screw3_name: rear right screw
screw4: 67.60, 212
screw4_name: rear left screw
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4 # Use CW for Clockwise and CCW for Counter Clockwise

[z_tilt]
z_positions:
  -31,125   #Z0
  260,125  #Z1
  118,272  #z2
points:
  15,-4
  220,-4
  118,184
horizontal_move_z: 5
retries: 10
retry_tolerance: 0.0075
speed: 400

[axis_twist_compensation]
calibrate_y: 117
calibrate_start_x: 20
calibrate_end_x: 215
calibrate_x: 117
calibrate_start_y: 11
calibrate_end_y: 184

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 #usbadxl
accel_chip: adxl345 
probe_points: 117,118,20 # an example
ACCEL_PER_HZ: 200

#[adxl345]
#cs_pin: cartographer:PA3
#spi_bus: spi1
#axes_map: x,y,z

#[resonance_tester]
#accel_chip: adxl345
#probe_points: 117, 118, 20

[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan

[temperature_sensor mcu]
sensor_type: temperature_mcu
sensor_mcu: mcu
[temperature_sensor host]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp

#[temperature_sensor Cartographer_mcu]
#sensor_type: temperature_mcu
#sensor_mcu: scanner


[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_data: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


########################################
# TMC2209 configuration
########################################

#[tmc2209 stepper_z]
#uart_pin: PC6
#diag_pin: PG10
#run_current: 0.567
#stealthchop_threshold: 999999

#[tmc2209 extruder]
#uart_pin: PD3
#run_current: 0.650
#hold_current: 0.1
#stealthchop_threshold: 0
#interpolate: False

#[heater_fan hotend_fan]
#pin: PE5
#max_power: 1.0
#kick_start_time: 0.5
#heater: extruder
#heater_temp: 50.0

#[heater_fan fan2]
#pin: PD12

#[heater_fan fan3]
#pin: PD13

#[heater_fan fan4]
#pin: PD14
#[controller_fan fan5]
#pin: PD15

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.443
#*# pid_ki = 1.409
#*# pid_kd = 433.861
#*#
#*# [input_shaper]
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.130094, -0.144482, -0.144913, -0.136283, -0.121105, -0.111357, -0.093864, -0.069746, -0.050321, -0.034779, -0.015384, -0.005154, -0.018113, -0.028287, -0.049012, -0.060533, -0.069427, -0.085938, -0.093705, -0.104466, -0.104174, -0.108184, -0.079033
#*# 	  -0.110519, -0.138414, -0.127748, -0.122981, -0.108028, -0.097281, -0.082230, -0.065618, -0.052394, -0.040761, -0.026610, -0.014247, -0.021035, -0.036566, -0.053845, -0.067038, -0.081174, -0.090241, -0.096870, -0.105985, -0.124840, -0.104788, -0.136994
#*# 	  -0.114934, -0.085678, -0.111361, -0.094732, -0.081288, -0.077290, -0.068758, -0.048658, -0.040013, -0.029439, -0.019765, -0.007331, -0.023277, -0.035874, -0.055136, -0.070176, -0.082890, -0.095255, -0.102809, -0.111590, -0.116357, -0.136411, -0.117464
#*# 	  -0.067284, -0.092490, -0.082832, -0.083011, -0.072006, -0.069560, -0.055908, -0.043467, -0.033680, -0.021564, -0.013661, -0.004995, -0.015523, -0.036963, -0.051987, -0.069998, -0.088821, -0.092306, -0.105569, -0.114762, -0.134448, -0.120224, -0.157434
#*# 	  -0.082725, -0.058343, -0.076413, -0.066814, -0.056715, -0.054701, -0.052683, -0.032914, -0.023273, -0.014831, -0.009530, 0.003361, -0.013291, -0.030031, -0.050069, -0.068929, -0.077794, -0.095639, -0.101982, -0.112412, -0.120861, -0.141554, -0.138195
#*# 	  -0.045210, -0.060569, -0.057375, -0.055927, -0.048542, -0.050587, -0.040173, -0.028067, -0.014949, -0.010391, -0.001026, 0.007085, -0.008486, -0.028039, -0.045539, -0.063103, -0.078476, -0.089284, -0.099229, -0.111325, -0.133909, -0.129519, -0.169023
#*# 	  -0.063281, -0.039498, -0.057677, -0.049434, -0.044656, -0.044131, -0.040525, -0.022641, -0.015749, -0.009771, -0.000500, 0.004667, -0.005912, -0.026817, -0.047285, -0.064171, -0.080157, -0.093482, -0.104204, -0.115480, -0.128279, -0.153728, -0.157253
#*# 	  -0.042408, -0.054684, -0.046207, -0.047577, -0.045257, -0.044507, -0.039626, -0.027682, -0.016781, -0.012492, -0.006580, -0.000031, -0.010828, -0.032764, -0.050698, -0.069186, -0.088235, -0.097856, -0.106524, -0.121626, -0.144775, -0.147844, -0.191928
#*# 	  -0.063058, -0.034993, -0.048536, -0.043239, -0.040438, -0.045777, -0.040792, -0.025014, -0.015095, -0.014361, -0.007973, -0.003869, -0.013713, -0.031988, -0.055300, -0.071848, -0.086792, -0.099365, -0.109170, -0.122905, -0.140506, -0.166529, -0.176202
#*# 	  -0.038433, -0.045888, -0.042209, -0.045637, -0.048325, -0.050648, -0.038450, -0.024663, -0.015819, -0.010874, -0.008566, -0.002330, -0.014858, -0.035277, -0.056413, -0.074100, -0.088290, -0.099261, -0.107589, -0.124439, -0.147760, -0.154608, -0.197355
#*# 	  -0.058790, -0.042337, -0.049144, -0.048879, -0.052999, -0.054670, -0.045688, -0.026281, -0.014933, -0.011492, -0.006799, -0.001244, -0.016967, -0.036068, -0.060496, -0.075153, -0.090428, -0.100443, -0.112085, -0.124186, -0.146170, -0.167099, -0.175630
#*# 	  -0.046119, -0.053614, -0.050951, -0.054724, -0.056610, -0.055251, -0.047898, -0.031170, -0.019826, -0.010676, -0.004204, 0.000220, -0.016413, -0.034609, -0.054283, -0.071401, -0.089396, -0.100206, -0.108434, -0.125832, -0.148416, -0.161601, -0.201208
#*# 	  -0.068651, -0.053675, -0.063682, -0.060304, -0.058150, -0.059087, -0.055856, -0.036058, -0.019974, -0.011821, -0.004439, 0.000397, -0.012720, -0.031553, -0.054787, -0.072193, -0.088161, -0.101774, -0.112768, -0.126146, -0.143646, -0.170706, -0.181112
#*# 	  -0.078042, -0.088150, -0.087508, -0.083635, -0.077279, -0.078534, -0.071419, -0.052302, -0.033764, -0.027642, -0.019473, -0.014179, -0.028841, -0.051274, -0.071670, -0.089311, -0.105059, -0.119726, -0.129898, -0.146940, -0.167755, -0.181083, -0.221707
#*# 	  -0.113747, -0.112578, -0.119819, -0.115420, -0.103799, -0.098647, -0.086700, -0.068063, -0.053729, -0.043616, -0.037404, -0.033548, -0.051794, -0.071174, -0.094416, -0.111563, -0.125732, -0.140154, -0.150492, -0.167157, -0.185370, -0.211562, -0.222022
#*# 	  -0.128422, -0.142052, -0.145700, -0.139305, -0.127588, -0.118822, -0.106679, -0.089539, -0.075006, -0.066913, -0.058292, -0.053354, -0.070505, -0.093471, -0.113432, -0.133144, -0.147340, -0.163303, -0.172998, -0.191099, -0.210010, -0.226678, -0.266637
#*# 	  -0.169224, -0.167978, -0.170328, -0.162268, -0.147822, -0.139731, -0.129975, -0.112520, -0.098834, -0.087137, -0.079868, -0.073216, -0.091213, -0.112182, -0.133016, -0.153682, -0.170736, -0.185861, -0.197302, -0.214233, -0.230230, -0.256266, -0.272737
#*# 	  -0.190814, -0.198978, -0.200778, -0.191684, -0.178573, -0.168282, -0.156127, -0.135239, -0.121256, -0.109693, -0.103667, -0.096981, -0.114858, -0.136248, -0.159214, -0.178525, -0.194689, -0.211072, -0.225748, -0.240776, -0.259362, -0.275187, -0.311903
#*# 	  -0.220836, -0.214851, -0.215346, -0.204930, -0.190923, -0.180020, -0.165118, -0.146959, -0.129719, -0.120012, -0.112820, -0.106462, -0.122588, -0.144383, -0.166278, -0.186116, -0.203536, -0.219899, -0.234141, -0.249963, -0.266033, -0.288926, -0.305554
#*# 	  -0.226247, -0.230346, -0.227888, -0.219096, -0.200693, -0.188841, -0.175576, -0.153065, -0.138936, -0.126839, -0.122076, -0.115012, -0.130328, -0.148552, -0.173364, -0.192654, -0.211235, -0.227624, -0.240540, -0.259044, -0.277194, -0.290804, -0.321978
#*# 	  -0.244136, -0.238230, -0.240040, -0.228549, -0.212399, -0.197367, -0.180142, -0.164306, -0.144960, -0.136491, -0.129557, -0.120232, -0.133269, -0.154216, -0.176385, -0.193400, -0.213807, -0.230638, -0.244896, -0.262027, -0.279817, -0.296404, -0.305889
#*# 	  -0.239251, -0.246895, -0.246474, -0.236309, -0.218136, -0.206294, -0.187459, -0.166863, -0.151649, -0.139910, -0.133104, -0.124912, -0.138017, -0.157769, -0.176760, -0.199101, -0.215607, -0.232279, -0.246187, -0.262840, -0.278080, -0.294220, -0.316422
#*# 	  -0.261243, -0.256578, -0.258277, -0.247761, -0.229844, -0.215820, -0.196125, -0.174396, -0.155537, -0.146274, -0.139068, -0.128498, -0.140489, -0.160460, -0.180946, -0.199938, -0.217543, -0.232065, -0.243934, -0.259154, -0.275152, -0.294209, -0.311488
#*# x_count = 23
#*# y_count = 23
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 214.92
#*# min_y = 20.0
#*# max_y = 214.92000000000013
#*#
#*# [cartographer scan_model default]
#*# z_offset = 0
#*# coefficients = 1.4986141535904032, 1.941444988144312, 0.8502011559917134, 0.33952044904949397, 0.25176039278093176, 0.6832247985892915, 0.10642367134097327, -0.7519135386893779, 0.09343333447252065, 0.4891501052840694
#*# domain = 3.209386724348187e-07, 3.3357096766991926e-07
#*#
#*# [cartographer touch_model default]
#*# threshold = 600
#*# speed = 1.0
#*# z_offset = -0.090
#*#
#*# [axis_twist_compensation]
#*# zy_compensations = -0.019303, -0.017714, 0.018143, -0.015163, 0.034037
#*# compensation_start_y = 11.0
#*# compensation_end_y = 184.0
#*# z_compensations = 0.032230, 0.008793, 0.028668, -0.027585, -0.042107
#*# compensation_start_x = 20.0
#*# compensation_end_x = 215.0
