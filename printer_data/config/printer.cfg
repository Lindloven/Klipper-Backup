# Enable object exclusion
[exclude_object]

# Enable arcs support
[gcode_arcs]
resolution: 0.1

[include K-ShakeTune/*.cfg]
[include Cartographer.cfg]
[include Ebb42.cfg]
#[include PIS.cfg]
[include Sensorless.cfg]
[include mainsail.cfg]
[include Macros.cfg]
[include KAMP_Settings.cfg]
[include ./KAMP/Voron_Purge.cfg]
[include Neopixel.cfg]

[mcu]
canbus_uuid: 3149463764eb

[gcode_macro START_PRINT]
gcode: 
    STATUS_READY
    #SET_GCODE_OFFSET Z=0
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(150)|float %}
    M140 S{BED_TEMP}
    M104 S150
     

    M117 print start
  
    G90  
    G28 
    Z_TILT_ADJUST
    STATUS_CALIBRATING_Z
    C_TOUCH
    STATUS_MESHING
    M117 Cartographer scanning bed...
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE=adaptive ADAPTIVE=1
    G1 X117 Y118 Z5

    
    G1 X-5 Y0
    STATUS_HEATING
    M117 heating...    
    M109 S{EXTRUDER_TEMP}        
    
    PROBE_SWITCH METHOD=scan
    
    #SET_GCODE_OFFSET Z_ADJUST=+0.00 MOVE=1
  
    #prusa purge
    G1 X3 Y3 Z0 F9000  ; move to corner 
    G1 Z0.2 F300 ; raise nozzle to 0.2
    G92 E0.0 ; reset extruder distance position
    G1 X60.0 E9.0 F1000.0 ; intro line
    G1 X100.0 E21.5 F1000.0 ; intro line
    G0 Z2
    G92 E0.0 ; reset extruder distance position
    
   #VORON_PURGE
  
  
[input_shaper]
shaper_freq_x: 99.2
shaper_type_x: mzv
shaper_freq_y: 85.2
shaper_type_y: mzv

[idle_timeout]
timeout: 14400
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[force_move]
enable_force_move: True

[stepper_x]
step_pin: PF13
dir_pin: !PF12
enable_pin: !PF14
microsteps: 64
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop #!PG6
position_endstop: 258
position_max: 258
position_min: -25
homing_speed: 60
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: ^PG6
run_current: 1.35
stealthchop_threshold: 0
driver_SGTHRS: 138  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110

[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
microsteps: 64
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop #!PG9
position_endstop: 237
position_max: 237
position_min: -25
homing_speed: 60
homing_positive_dir: true
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
run_current: 1.35
stealthchop_threshold: 0
driver_SGTHRS: 130  # 255 is most sensitive value, 0 is least sensitive
interpolate: False
sense_resistor: 0.110

[stepper_z]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
microsteps: 128
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 260
position_min: -5
homing_speed: 5
second_homing_speed: 1
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: PE4
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z1]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z1]
uart_pin: PE1
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[stepper_z2]
step_pin: PE6
dir_pin: !PA14
enable_pin: !PE0
microsteps: 128
rotation_distance: 8

[tmc2209 stepper_z2]
uart_pin: PD3
run_current: 0.65
stealthchop_threshold: 0
interpolate: False
#sense_resistor: 0.110

[heater_bed]
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
#control: pid
# tuned for stock hardware with 70 degree Celsius target
#pid_kp: 70.405
#pid_ki: 1.229
#pid_kd: 1008.553
min_temp: 0
max_temp: 200

[controller_fan Step]
pin: PA8
fan_speed: 1.0
stepper: stepper_x, stepper_y

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 21200
max_z_velocity: 5
square_corner_velocity: 5.0
max_z_accel: 100

[bed_mesh]
speed: 400
mesh_min: 15,15        # Need to handle head distance with cr-touch (bl_touch)
mesh_max: 220,220      # Max probe range
probe_count: 19,19
fade_start: 1
fade_end: 10
fade_target: 0
#mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2

[bed_screws]
screw1:25,40
screw1_name:1
screw2:195,40
screw2_name:2
screw3:25,210
screw3_name:3
screw4:195,210
screw4_name:4

[screws_tilt_adjust]
screw1: 67, 42
screw1_name: front left screw
screw2: 237.60, 42
screw2_name: front right screw
screw3: 237.60, 212
screw3_name: rear right screw
screw4: 67.60, 212
screw4_name: rear left screw
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4 # Use CW for Clockwise and CCW for Counter Clockwise

[z_tilt]
z_positions:
  -31,125   #Z0
  260,125  #Z1
  118,272  #z2
points:
  15,-4
  #118,15
  220,-4
  118,196
horizontal_move_z: 5
retries: 10
retry_tolerance: 0.005
speed: 400

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 #usbadxl
accel_chip: adxl345 
probe_points: 117,118,20 # an example

#[adxl345]
#cs_pin: cartographer:PA3
#spi_bus: spi1

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
    #125, 125, 20

[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan

[temperature_sensor mcu]
sensor_type: temperature_mcu
sensor_mcu: mcu
[temperature_sensor host]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


#[safe_z_home]
#home_xy_position: 160,120
#speed: 150
#z_hop: 10
#z_hop_speed: 10

########################################
# TMC2209 configuration
########################################

#[tmc2209 extruder]
#uart_pin: PF2
#run_current: 0.600
#stealthchop_threshold: 999999

#[tmc2209 stepper_z]
#uart_pin: PC6
#diag_pin: PG10
#run_current: 0.567
#stealthchop_threshold: 999999

#[tmc2209 stepper_z1]
#uart_pin: PC7
#diag_pin: PG11
#run_current: 0.567
#stealthchop_threshold: 999999

#[tmc2209 extruder]
#uart_pin: PD3
#run_current: 0.650
#hold_current: 0.1
#stealthchop_threshold: 0
#interpolate: False


#[heater_fan hotend_fan]
#pin: PE5
#max_power: 1.0
#kick_start_time: 0.5
#heater: extruder
#heater_temp: 50.0

#[heater_fan fan2]
#pin: PD12

#[heater_fan fan3]
#pin: PD13

#[heater_fan fan4]
#pin: PD14
#[controller_fan fan5]
#pin: PD15

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.443
#*# pid_ki = 1.409
#*# pid_kd = 433.861
#*#
#*# [input_shaper]
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.365774, -0.355252, -0.360640, -0.346052, -0.361257, -0.362303, -0.367205, -0.360191, -0.354319, -0.345567, -0.356687, -0.357940, -0.359440, -0.338255, -0.325458, -0.336265, -0.344165, -0.347393, -0.366880
#*# 	-0.369058, -0.361671, -0.353765, -0.341870, -0.341762, -0.352453, -0.352136, -0.343774, -0.330991, -0.330157, -0.337092, -0.345423, -0.341792, -0.328525, -0.311333, -0.322464, -0.336196, -0.345412, -0.371528
#*# 	-0.364270, -0.352307, -0.346773, -0.329448, -0.340826, -0.333997, -0.339488, -0.329611, -0.314897, -0.307133, -0.312014, -0.320989, -0.325216, -0.309908, -0.296355, -0.306950, -0.313967, -0.322838, -0.339930
#*# 	-0.347472, -0.337099, -0.330207, -0.317796, -0.320048, -0.323594, -0.318873, -0.313518, -0.296943, -0.281482, -0.287213, -0.300050, -0.305702, -0.294798, -0.276803, -0.287224, -0.296216, -0.298687, -0.329600
#*# 	-0.338084, -0.329013, -0.321315, -0.307367, -0.311368, -0.311085, -0.303047, -0.294381, -0.271146, -0.259318, -0.268597, -0.283368, -0.291020, -0.267898, -0.259132, -0.262215, -0.272557, -0.277128, -0.311009
#*# 	-0.330245, -0.324150, -0.313863, -0.305721, -0.304494, -0.305397, -0.297897, -0.281589, -0.262598, -0.253322, -0.262314, -0.269834, -0.272779, -0.253751, -0.239973, -0.248065, -0.254783, -0.263261, -0.286441
#*# 	-0.327032, -0.317219, -0.304433, -0.298987, -0.296283, -0.296978, -0.288524, -0.272487, -0.257806, -0.250905, -0.249541, -0.243713, -0.242697, -0.226523, -0.221911, -0.221031, -0.230060, -0.236735, -0.266182
#*# 	-0.322985, -0.312335, -0.301828, -0.293356, -0.287798, -0.295452, -0.291335, -0.278684, -0.264809, -0.255418, -0.245287, -0.228851, -0.223820, -0.212717, -0.201654, -0.201272, -0.206965, -0.217192, -0.244480
#*# 	-0.319840, -0.308900, -0.297739, -0.287186, -0.282969, -0.293910, -0.298065, -0.282174, -0.264193, -0.245714, -0.235152, -0.218119, -0.212525, -0.199564, -0.182814, -0.180116, -0.182321, -0.189540, -0.215394
#*# 	-0.318418, -0.301290, -0.289941, -0.281683, -0.281025, -0.291428, -0.295444, -0.281812, -0.256827, -0.231463, -0.217901, -0.202878, -0.201520, -0.178411, -0.167046, -0.159547, -0.161101, -0.168927, -0.190375
#*# 	-0.318369, -0.300901, -0.287224, -0.276588, -0.271931, -0.291743, -0.294124, -0.272506, -0.247691, -0.220308, -0.200832, -0.191701, -0.185217, -0.168510, -0.147827, -0.139536, -0.143064, -0.142242, -0.163695
#*# 	-0.316918, -0.302637, -0.284027, -0.271991, -0.266731, -0.286728, -0.286287, -0.261961, -0.235361, -0.205048, -0.195805, -0.182350, -0.180558, -0.152290, -0.136035, -0.120689, -0.129309, -0.120612, -0.138218
#*# 	-0.316490, -0.296330, -0.281906, -0.262910, -0.256934, -0.275139, -0.273786, -0.250199, -0.223447, -0.202710, -0.191769, -0.183065, -0.169199, -0.141931, -0.114210, -0.104961, -0.105270, -0.100510, -0.114924
#*# 	-0.310487, -0.294480, -0.275538, -0.261940, -0.249772, -0.259740, -0.256381, -0.237640, -0.210139, -0.197441, -0.188724, -0.170931, -0.161061, -0.121606, -0.099925, -0.083595, -0.090826, -0.078011, -0.088701
#*# 	-0.297342, -0.276732, -0.263448, -0.244830, -0.236875, -0.244218, -0.242827, -0.222559, -0.198328, -0.181270, -0.167068, -0.156921, -0.140307, -0.110215, -0.075744, -0.067379, -0.065580, -0.056621, -0.060991
#*# 	-0.278269, -0.261218, -0.246249, -0.234346, -0.223215, -0.229115, -0.224680, -0.209122, -0.180135, -0.163545, -0.148812, -0.135365, -0.118816, -0.087741, -0.056136, -0.045270, -0.041771, -0.029369, -0.027630
#*# 	-0.253218, -0.230227, -0.219649, -0.204554, -0.197468, -0.201978, -0.199164, -0.187175, -0.155438, -0.141179, -0.119713, -0.112161, -0.091217, -0.064958, -0.025906, -0.018088, -0.014186, -0.000317, 0.006289
#*# 	-0.208683, -0.196448, -0.187718, -0.178638, -0.172074, -0.171690, -0.178128, -0.155147, -0.134059, -0.110587, -0.099830, -0.080520, -0.070007, -0.036364, -0.001686, 0.012240, 0.028400, 0.036895, 0.052120
#*# 	-0.207556, -0.226004, -0.232384, -0.228812, -0.222926, -0.227615, -0.224243, -0.209879, -0.185011, -0.170836, -0.159547, -0.146928, -0.128099, -0.098608, -0.064047, -0.040850, -0.033512, -0.013510, -0.005724
#*# x_count = 19
#*# y_count = 19
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 220.0
#*# min_y = 15.0
#*# max_y = 220.0
#*#
#*# [scanner model default]
#*# model_coef = 1.3878013446242976,
#*# 	  1.8170030514256328,
#*# 	  0.7616848669693966,
#*# 	  0.26242456291167404,
#*# 	  0.34960204136838763,
#*# 	  0.6873701123454,
#*# 	  -0.18199072525698756,
#*# 	  -0.7340716559132802,
#*# 	  0.2324187890735121,
#*# 	  0.41806426103806477
#*# model_domain = 3.1852486943202074e-07,3.3159460195012907e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 40.434946
#*# model_offset = 0.00000
